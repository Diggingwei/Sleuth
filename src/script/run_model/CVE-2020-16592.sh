export MYPATH=$SLEUTH_PATH/src
export VULN=CVE-2020-16592
export VULN_DIR=project/binutils_project/binutils
export VULN_TOOL=$VULN_DIR/bfd
export TOOL=binutils/nm-new
export SINGLETOOL=nm-new
export OBJECT=$MYPATH/$VULN_DIR
echo "================"
cd $OBJECT
make distclean
git checkout -f 0ca4866abeb9ff668fe64064fc1bceb08ca63833
echo "========check version done========="
source $MYPATH'/evn/instrument.sh'
./configure --disable-shared --disable-gdb --disable-werror
make all-binutils > test.log
echo "========init make done========" 
cd $MYPATH/vuln_tool
./run.sh $VULN > $MYPATH/$VULN_DIR/../$VULN/record.log
cd ../$VULN_TOOL
$SLEUTH_PATH/ddgAnalysis/build/tools/dataflow-cc -emit-llvm -DHAVE_CONFIG_H -I.  -DBINDIR='"/usr/local/bin"' -DLIBDIR='"/usr/local/lib"' -I. -I. -I./../include  -DHAVE_x86_64_elf64_vec -DHAVE_i386_elf32_vec -DHAVE_iamcu_elf32_vec -DHAVE_x86_64_elf32_vec -DHAVE_i386_pei_vec -DHAVE_x86_64_pei_vec -DHAVE_l1om_elf64_vec -DHAVE_k1om_elf64_vec -DHAVE_elf64_le_vec -DHAVE_elf64_be_vec -DHAVE_elf32_le_vec -DHAVE_elf32_be_vec   -W -Wall -Wstrict-prototypes -Wmissing-prototypes -Wshadow -I./../zlib -g -O0 -g -O0 -MT hash.o.bc -MD -MP -MF .deps/hash.Tpo -S -o hash.o.bc hash.c >> $MYPATH/$VULN_DIR/../$VULN/record.log
$SLEUTH_PATH/ddgAnalysis/build/tools/static-dua --ander hash.o.bc --out=$MYPATH/vulnInfo/target.json >> $MYPATH/$VULN_DIR/../$VULN/record.log
echo "========analysis done========="
cd $OBJECT
make clean
DDG_INSTR=1 AFL_LLVM_INSTRUMENT=classic make all-binutils | grep "DDG - Instrumented" >> $MYPATH/$VULN_DIR/../$VULN/record.log
mkdir -p fuzz_$VULN/in
cp $TOOL 'fuzz_'$VULN'/'$SINGLETOOL'_cov'
cp ../$VULN/poc fuzz_$VULN/in/
echo "========netfuzz compiler done========"
make distclean
source $MYPATH/evn/comp_instrument.sh
./configure --disable-shared --disable-gdb --disable-werror
AFL_LLVM_INSTRUMENT=classic make all-binutils > test.log
mkdir -p comp_fuzz_$VULN/in
cp $TOOL 'comp_fuzz_'$VULN'/'$SINGLETOOL'_cov'
cp ../$VULN/poc comp_fuzz_$VULN/in/
echo "========AFL++ compiler done========"

