export MYPATH=$SLEUTH_PATH/src
export VULN=CVE-2021-26926
export VULN_DIR=project/jasper_project/jasper
export VULN_TOOL=$VULN_DIR/Build
export TOOL=src/appl/jasper
export SINGLETOOL=jasper
export OBJECT=$MYPATH/$VULN_DIR
echo "================"
cd $OBJECT
rm -rf Build
mkdir Build
git checkout -f 573a6e4
echo "========check version done========="
cd Build
source $MYPATH'/evn/instrument.sh'
export CFLAGS="-g"
export CXXFLAGS="-g"
cmake -DJAS_ENABLE_SHARED=OFF -DALLOW_IN_SOURCE_BUILD=ON ..
make
echo "========init make done========" 
cd $MYPATH/vuln_tool
./run.sh $VULN > $MYPATH/$VULN_DIR/../$VULN/record.log
cd ../$VULN_TOOL
$SLEUTH_PATH/ddgAnalysis/build/tools/dataflow-cc -emit-llvm -DJAS_BUILDING_DLL -D_GNU_SOURCE -I/Sleuth_code/src/project/jasper_project/jasper/Build/src/libjasper/include -I/Sleuth_code/src/project/jasper_project/jasper/src/libjasper/include -g -O0 -Wall -pedantic -W -Wformat -Wmissing-prototypes -Wstrict-prototypes -Wmissing-declarations -Wredundant-decls -fPIC -std=gnu11 -MD -MT src/libjasper/CMakeFiles/libjasper.dir/jp2/jp2_dec.o.bc -MF src/libjasper/CMakeFiles/libjasper.dir/jp2/jp2_dec.c.o.d -o src/libjasper/CMakeFiles/libjasper.dir/jp2/jp2_dec.o.bc -S /Sleuth_code/src/project/jasper_project/jasper/src/libjasper/jp2/jp2_dec.c >> $MYPATH/$VULN_DIR/../$VULN/record.log
$SLEUTH_PATH/ddgAnalysis/build/tools/static-dua --ander src/libjasper/CMakeFiles/libjasper.dir/jp2/jp2_dec.o.bc --out=$MYPATH/vulnInfo/target.json >> $MYPATH/$VULN_DIR/../$VULN/record.log
echo "========analysis done========="
cd $OBJECT/Build
make clean
DDG_INSTR=1 AFL_LLVM_INSTRUMENT=classic make | grep "DDG - Instrumented" >> $MYPATH/$VULN_DIR/../$VULN/record.log
cd $OBJECT
mkdir -p fuzz_$VULN/in
cp Build/$TOOL 'fuzz_'$VULN'/'$SINGLETOOL'_cov'
cp ../$VULN/poc fuzz_$VULN/in/
echo "========Sleuth compiler done========"
rm -rf Build
source $MYPATH/evn/comp_instrument.sh
export CFLAGS="-g"
export CXXFLAGS="-g"
cd Build
cmake ..
AFL_LLVM_INSTRUMENT=classic make > test.log
cd $OBJECT
mkdir -p comp_fuzz_$VULN/in
cp Build/$TOOL 'comp_fuzz_'$VULN'/'$SINGLETOOL'_cov'
cp ../$VULN/poc comp_fuzz_$VULN/in/
echo "========AFL++ compiler done========"
